<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Character Frequency Visualizer</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0a0f;
    --bg-secondary: #12121a;
    --bg-tertiary: #1a1a26;
    --bg-card: #14141e;
    --text-primary: #e8e8f0;
    --text-secondary: #8888a0;
    --text-muted: #555570;
    --accent: #4a7cff;
    --border: #2a2a3a;
    --cold: #1a3a6a;
    --cold-mid: #2a5a9a;
    --warm: #cc4444;
    --hot: #ff3333;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: 'Outfit', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .grain-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 999;
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px 60px;
  }

  header {
    text-align: center;
    margin-bottom: 40px;
  }

  header h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.6rem;
    font-weight: 600;
    letter-spacing: -0.02em;
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  header h1 span {
    color: var(--accent);
  }

  header p {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-weight: 300;
  }

  .input-section {
    margin-bottom: 36px;
    position: relative;
  }

  textarea {
    width: 100%;
    height: 110px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    padding: 16px 20px;
    resize: none;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
    line-height: 1.6;
  }

  textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(74, 124, 255, 0.12);
  }

  textarea::placeholder {
    color: var(--text-muted);
    font-family: 'Outfit', sans-serif;
    font-weight: 300;
  }

  .char-counter {
    position: absolute;
    bottom: 12px;
    right: 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: var(--text-muted);
    transition: color 0.3s;
  }

  .char-counter.warning { color: #cc8844; }
  .char-counter.danger { color: var(--warm); }

  .stats-row {
    display: flex;
    gap: 12px;
    margin-bottom: 36px;
    flex-wrap: wrap;
  }

  .stat-pill {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.78rem;
  }

  .stat-pill .label {
    color: var(--text-muted);
    font-weight: 300;
  }

  .stat-pill .value {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
    color: var(--accent);
  }

  .section-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title::before {
    content: '';
    width: 3px;
    height: 14px;
    background: var(--accent);
    border-radius: 2px;
  }

  /* ─── Bar Chart ─── */
  .chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    margin-bottom: 36px;
  }

  .bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 200px;
    padding-top: 10px;
    position: relative;
  }

  .bar-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    justify-content: flex-end;
    position: relative;
  }

  .bar {
    width: 100%;
    min-height: 0;
    border-radius: 3px 3px 0 0;
    transition: height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.3s;
    position: relative;
    cursor: pointer;
  }

  .bar:hover {
    filter: brightness(1.3);
  }

  .bar-tooltip {
    position: absolute;
    top: -28px;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: #fff;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    padding: 3px 7px;
    border-radius: 4px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    white-space: nowrap;
    z-index: 10;
  }

  .bar:hover .bar-tooltip { opacity: 1; }

  .bar-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    color: var(--text-muted);
    margin-top: 6px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .y-axis-labels {
    position: absolute;
    left: -30px;
    top: 0;
    bottom: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .y-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.55rem;
    color: var(--text-muted);
  }

  /* ─── Keyboard ─── */
  .keyboard-section {
    margin-bottom: 36px;
  }

  .keyboard {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: center;
  }

  .kb-row {
    display: flex;
    gap: 6px;
  }

  .key {
    position: relative;
    width: 56px;
    height: 56px;
    border-radius: 8px;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.35s ease;
    cursor: default;
    overflow: hidden;
  }

  .key .letter {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    z-index: 1;
    transition: color 0.3s;
    text-transform: uppercase;
  }

  .key .count {
    position: absolute;
    bottom: 4px;
    right: 5px;
    font-size: 0.55rem;
    font-weight: 500;
    color: rgba(255,255,255,0.5);
    z-index: 1;
    transition: color 0.3s;
  }

  .key.active .count {
    color: rgba(255,255,255,0.85);
  }

  .key-number {
    width: 50px;
    height: 46px;
  }

  .key-wide {
    width: 80px;
  }

  .key-space {
    width: 320px;
  }

  /* ─── Layout Toggle ─── */
  .layout-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    justify-content: flex-end;
  }

  .layout-toggle .toggle-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.68rem;
    color: var(--text-muted);
    font-weight: 400;
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid transparent;
    transition: all 0.25s ease;
  }

  .layout-toggle .toggle-label:hover {
    color: var(--text-secondary);
  }

  .layout-toggle .toggle-label.active {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(74, 124, 255, 0.08);
  }

  /* ─── Split Keyboard (Sofle) ─── */
  .keyboard-split {
    display: flex;
    gap: 40px;
    justify-content: center;
    align-items: flex-start;
  }

  .keyboard-half {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: center;
  }

  .kb-row-stagger {
    display: flex;
    gap: 6px;
    align-items: flex-end;
  }

  .key-stagger {
    position: relative;
  }

  .key-small {
    width: 46px;
    height: 46px;
  }

  .key-small .letter {
    font-size: 0.75rem;
  }

  .key-small .count {
    font-size: 0.48rem;
  }

  .key-mod {
    width: 46px;
    height: 46px;
    opacity: 0.45;
  }

  .key-mod .letter {
    font-size: 0.5rem;
    text-transform: none;
  }

  .key-encoder {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    opacity: 0.35;
  }

  .key-encoder .letter {
    font-size: 0.48rem;
    text-transform: none;
  }

  .key-thumb {
    width: 44px;
    height: 38px;
    border-radius: 8px 8px 14px 14px;
    opacity: 0.45;
  }

  .key-thumb .letter {
    font-size: 0.45rem;
    text-transform: none;
  }

  /* ─── Color Scale Legend ─── */
  .legend {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 20px;
    justify-content: center;
  }

  .legend-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-muted);
    font-weight: 400;
  }

  .legend-bar {
    width: 200px;
    height: 10px;
    border-radius: 5px;
    background: linear-gradient(to right, #1a2a44, #1a3a6a, #2a5a9a, #6a8a44, #ccaa22, #cc6622, #cc3333, #ff2222);
  }

  /* ─── Empty State ─── */
  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 300;
  }

  .empty-state .icon {
    font-size: 2rem;
    margin-bottom: 10px;
    opacity: 0.4;
  }

  /* ─── Gematria Section ─── */
  .gematria-total {
    text-align: center;
    padding: 20px 0 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }

  .gematria-total-label {
    font-family: 'Outfit', sans-serif;
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
  }

  .gematria-total-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2.8rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 6px;
    transition: color 0.3s;
  }

  .gematria-total-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
    font-weight: 300;
  }

  .gematria-words {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
  }

  .gem-word {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    display: flex;
    align-items: baseline;
    gap: 8px;
    transition: border-color 0.3s;
  }

  .gem-word:hover {
    border-color: var(--accent);
  }

  .gem-word-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-primary);
    font-weight: 500;
  }

  .gem-word-eq {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .gem-word-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--accent);
  }

  .gematria-letters-toggle,
  .gematria-ref-toggle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: 10px 0;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: color 0.2s;
  }

  .gematria-letters-toggle:hover,
  .gematria-ref-toggle:hover {
    color: var(--text-secondary);
  }

  .gem-toggle-arrow {
    font-size: 0.6rem;
    transition: transform 0.3s;
  }

  .gem-toggle-arrow.open {
    transform: rotate(180deg);
  }

  .gematria-letters {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    padding: 12px 0;
  }

  .gem-letter {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 8px;
    text-align: center;
    min-width: 48px;
    transition: background 0.3s;
  }

  .gem-letter-char {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .gem-letter-hebrew {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 2px;
  }

  .gem-letter-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent);
    font-weight: 500;
    margin-top: 2px;
  }

  .gem-letter.non-alpha {
    opacity: 0.3;
    border-color: transparent;
    min-width: 32px;
  }

  .gematria-ref {
    padding: 12px 0;
  }

  .gem-ref-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 4px;
  }

  .gem-ref-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
  }

  .gem-ref-eng {
    color: var(--text-primary);
    font-weight: 600;
    width: 14px;
  }

  .gem-ref-heb {
    color: var(--text-secondary);
    width: 20px;
    text-align: center;
  }

  .gem-ref-name {
    color: var(--text-muted);
    flex: 1;
  }

  .gem-ref-val {
    color: var(--accent);
    font-weight: 500;
  }

  /* ─── Root Number / Digital Root ─── */
  .gematria-totals-row {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 40px;
    padding: 20px 0 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }

  .gematria-total-block {
    text-align: center;
    flex: 0 1 auto;
  }

  .root-number-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2.8rem;
    font-weight: 700;
    color: #b388ff;
    line-height: 1;
    margin-bottom: 6px;
    transition: color 0.3s;
  }

  .root-number-steps {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
    font-weight: 300;
    margin-top: 2px;
  }

  .root-step-arrow {
    color: var(--text-muted);
    opacity: 0.5;
    margin: 0 3px;
  }

  .root-step-final {
    color: #b388ff;
    font-weight: 600;
  }

  .gematria-divider {
    width: 1px;
    background: var(--border);
    align-self: stretch;
    margin: 4px 0;
  }

  /* ─── Explanation Panel ─── */
  .gematria-explainer {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
    margin-bottom: 20px;
  }

  .gematria-explainer-toggle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: color 0.2s;
  }

  .gematria-explainer-toggle:hover {
    color: var(--text-secondary);
  }

  .gematria-explainer-body {
    padding-top: 14px;
    font-size: 0.78rem;
    line-height: 1.7;
    color: var(--text-secondary);
    font-weight: 300;
  }

  .gematria-explainer-body strong {
    color: var(--text-primary);
    font-weight: 500;
  }

  .gematria-explainer-body .explain-step {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin: 10px 0;
    padding: 8px 12px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    border-left: 3px solid var(--accent);
  }

  .gematria-explainer-body .explain-step.step-root {
    border-left-color: #b388ff;
  }

  .explain-step-num {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--accent);
    flex-shrink: 0;
    margin-top: 1px;
  }

  .explain-step.step-root .explain-step-num {
    color: #b388ff;
  }

  .explain-step-text {
    flex: 1;
  }

  .gematria-explainer-body .explain-note {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 10px;
    font-style: italic;
  }

  /* ─── Responsive ─── */
  @media (max-width: 768px) {
    .container { padding: 24px 14px; }
    .key { width: 34px; height: 40px; }
    .key .letter { font-size: 0.7rem; }
    .key .count { font-size: 0.45rem; }
    .key-number { width: 30px; height: 34px; }
    .key-wide { width: 50px; }
    .key-space { width: 180px; }
    .kb-row { gap: 3px; }
    .keyboard { gap: 3px; }
    .bar-chart { height: 150px; }
    .bar-label { font-size: 0.45rem; }
    .keyboard-split { gap: 16px; }
    .key-small { width: 30px; height: 34px; }
    .key-small .letter { font-size: 0.55rem; }
    .key-small .count { font-size: 0.38rem; }
    .key-mod { width: 30px; height: 34px; }
    .key-mod .letter { font-size: 0.4rem; }
    .key-encoder { width: 28px; height: 28px; }
    .key-thumb { width: 30px; height: 28px; }
    .key-thumb .letter { font-size: 0.38rem; }
    .layout-toggle .toggle-label { font-size: 0.58rem; padding: 3px 7px; }
    .gematria-total-value { font-size: 2rem; }
    .root-number-value { font-size: 2rem; }
    .gematria-totals-row { gap: 20px; }
    .gem-word { padding: 6px 10px; }
    .gem-word-text { font-size: 0.7rem; }
    .gem-letter { min-width: 38px; padding: 4px 6px; }
    .gem-ref-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
  }
</style>
</head>
<body>

<div class="grain-overlay"></div>

<div class="container">
  <header>
    <h1>char<span>freq</span></h1>
    <p>Real-time character frequency analysis & keyboard heatmap</p>
  </header>

  <div class="input-section">
    <textarea id="textInput" maxlength="500" placeholder="Start typing to see the frequency distribution and keyboard heatmap light up..."></textarea>
    <div class="char-counter" id="charCounter">0 / 500</div>
  </div>

  <div class="stats-row" id="statsRow">
    <div class="stat-pill"><span class="label">Total chars</span><span class="value" id="statTotal">0</span></div>
    <div class="stat-pill"><span class="label">Letters</span><span class="value" id="statLetters">0</span></div>
    <div class="stat-pill"><span class="label">Unique</span><span class="value" id="statUnique">0</span></div>
    <div class="stat-pill"><span class="label">Most used</span><span class="value" id="statTop">—</span></div>
    <div class="stat-pill"><span class="label">Gematria</span><span class="value" id="statGematria">0</span></div>
    <div class="stat-pill"><span class="label">Root #</span><span class="value" id="statRoot" style="color:#b388ff">0</span></div>
  </div>

  <div class="section-title">Frequency Distribution</div>
  <div class="chart-card">
    <div class="bar-chart" id="barChart"></div>
  </div>

  <div class="section-title">Keyboard Heatmap</div>
  <div class="chart-card">
    <div class="layout-toggle" id="layoutToggle">
      <span class="toggle-label active" data-layout="standard">Standard</span>
      <span class="toggle-label" data-layout="sofle">Sofle v2</span>
    </div>
    <div class="keyboard" id="keyboard"></div>
    <div class="legend">
      <span class="legend-label">0</span>
      <div class="legend-bar"></div>
      <span class="legend-label">max</span>
    </div>
  </div>

  <div class="section-title">Kabbalistic Gematria</div>
  <div class="chart-card" id="gematriaSection" dir="ltr">
    <div class="gematria-totals-row">
      <div class="gematria-total-block">
        <div class="gematria-total-label">Gematria Value</div>
        <div class="gematria-total-value" id="gemTotalValue">0</div>
        <div class="gematria-total-sub" id="gemTotalSub"></div>
      </div>
      <div class="gematria-divider"></div>
      <div class="gematria-total-block">
        <div class="gematria-total-label">Root Number</div>
        <div class="root-number-value" id="rootNumberValue">0</div>
        <div class="root-number-steps" id="rootNumberSteps"></div>
      </div>
    </div>

    <div class="gematria-explainer" id="gematriaExplainer">
      <div class="gematria-explainer-toggle" id="gemExplainerToggle">
        <span>How does this work?</span>
        <span class="gem-toggle-arrow" id="gemExplainerArrow">&#9660;</span>
      </div>
      <div class="gematria-explainer-body" id="gemExplainerBody" style="display: none;">
        <p>Gematria and the root number are two steps of the same process:</p>

        <div class="explain-step">
          <span class="explain-step-num">1</span>
          <span class="explain-step-text">
            <strong>Gematria (Mispar Hechrachi)</strong> &mdash; Each letter maps to a number
            (A=1, B=2 &hellip; J=10, K=20 &hellip; T=200, V=400). Add them all up and you get
            the <strong>gematria value</strong> &mdash; the raw numerical "weight" of your text.
          </span>
        </div>

        <div class="explain-step step-root">
          <span class="explain-step-num">2</span>
          <span class="explain-step-text">
            <strong>Root Number (Mispar Katan Mispari)</strong> &mdash; Take that total and keep
            adding the digits together until only a single digit (1&ndash;9) remains. For example:
            <strong>782 &rarr; 7+8+2 = 17 &rarr; 1+7 = 8</strong>. That final digit is the
            root number &mdash; a kind of single-digit "signature" of your text.
          </span>
        </div>

        <p class="explain-note">
          In Kabbalistic tradition, the Vilna Gaon showed that many traditional Shabbat foods
          all reduce to a root number of 7 (the seventh day). The root number is mathematically
          equivalent to the value mod 9 &mdash; it stays the same regardless of which gematria
          encoding you start from, giving it a special invariance.
        </p>
      </div>
    </div>

    <div class="gematria-words" id="gematriaWords">
      <div class="empty-state" style="width:100%">
        <div class="icon">&#x05D0;</div>
        <div>Type something to see its gematria value</div>
      </div>
    </div>

    <div class="gematria-letters-toggle" id="gemLettersToggle">
      <span>Letter Breakdown</span>
      <span class="gem-toggle-arrow" id="gemToggleArrow">&#9660;</span>
    </div>
    <div class="gematria-letters" id="gematriaLetters" style="display: none;"></div>

    <div class="gematria-ref-toggle" id="gemRefToggle">
      <span>Mapping Reference</span>
      <span class="gem-toggle-arrow" id="gemRefArrow">&#9660;</span>
    </div>
    <div class="gematria-ref" id="gematriaRef" style="display: none;"></div>
  </div>
</div>

<script>
  const LETTERS = 'abcdefghijklmnopqrstuvwxyz'.split('');
  const NUMBERS = '1234567890'.split('');

  const KB_ROWS = [
    { keys: NUMBERS, type: 'number' },
    { keys: 'qwertyuiop'.split(''), type: 'letter' },
    { keys: 'asdfghjkl'.split(''), type: 'letter' },
    { keys: 'zxcvbnm'.split(''), type: 'letter' },
  ];

  // Sofle v2: 6×4+5 column-staggered split keyboard
  // Each half row: array of { key, type } where type = 'char' | 'mod' | 'encoder' | 'thumb'
  // Column stagger offsets (px) per column for each half (pinky to index+inner)
  const SOFLE_COL_OFFSETS_L = [12, 6, 0, 3, 8, 12]; // left: pinky→inner
  const SOFLE_COL_OFFSETS_R = [12, 8, 3, 0, 6, 12]; // right: inner→pinky

  const SOFLE_LEFT = [
    // Row 1: Number row
    [
      { key: '`', type: 'mod' }, { key: '1', type: 'char' }, { key: '2', type: 'char' },
      { key: '3', type: 'char' }, { key: '4', type: 'char' }, { key: '5', type: 'char' },
    ],
    // Row 2: Top alpha
    [
      { key: 'Esc', type: 'mod' }, { key: 'q', type: 'char' }, { key: 'w', type: 'char' },
      { key: 'e', type: 'char' }, { key: 'r', type: 'char' }, { key: 't', type: 'char' },
    ],
    // Row 3: Home row
    [
      { key: 'Tab', type: 'mod' }, { key: 'a', type: 'char' }, { key: 's', type: 'char' },
      { key: 'd', type: 'char' }, { key: 'f', type: 'char' }, { key: 'g', type: 'char' },
    ],
    // Row 4: Bottom alpha
    [
      { key: 'Sft', type: 'mod' }, { key: 'z', type: 'char' }, { key: 'x', type: 'char' },
      { key: 'c', type: 'char' }, { key: 'v', type: 'char' }, { key: 'b', type: 'char' },
    ],
    // Row 5: Thumb cluster
    [
      { key: 'Gui', type: 'thumb' }, { key: 'Alt', type: 'thumb' }, { key: 'Ctrl', type: 'thumb' },
      { key: 'Lo', type: 'thumb' }, { key: 'Ent', type: 'thumb' },
    ],
  ];

  const SOFLE_RIGHT = [
    // Row 1: Number row
    [
      { key: '6', type: 'char' }, { key: '7', type: 'char' }, { key: '8', type: 'char' },
      { key: '9', type: 'char' }, { key: '0', type: 'char' }, { key: '`', type: 'mod' },
    ],
    // Row 2: Top alpha
    [
      { key: 'y', type: 'char' }, { key: 'u', type: 'char' }, { key: 'i', type: 'char' },
      { key: 'o', type: 'char' }, { key: 'p', type: 'char' }, { key: 'Bks', type: 'mod' },
    ],
    // Row 3: Home row
    [
      { key: 'h', type: 'char' }, { key: 'j', type: 'char' }, { key: 'k', type: 'char' },
      { key: 'l', type: 'char' }, { key: ';', type: 'mod' }, { key: "'", type: 'mod' },
    ],
    // Row 4: Bottom alpha
    [
      { key: 'n', type: 'char' }, { key: 'm', type: 'char' }, { key: ',', type: 'mod' },
      { key: '.', type: 'mod' }, { key: '/', type: 'mod' }, { key: 'Sft', type: 'mod' },
    ],
    // Row 5: Thumb cluster
    [
      { key: 'Spc', type: 'thumb' }, { key: 'Ra', type: 'thumb' }, { key: 'Ctrl', type: 'thumb' },
      { key: 'Alt', type: 'thumb' }, { key: 'Gui', type: 'thumb' },
    ],
  ];

  // Kabbalistic Gematria (Mispar Hechrachi) — English → Hebrew mapping
  const GEMATRIA = {
    a: { hebrew: '\u05D0', name: 'Aleph',      value: 1 },
    b: { hebrew: '\u05D1', name: 'Bet',        value: 2 },
    c: { hebrew: '\u05D2', name: 'Gimel',      value: 3 },
    d: { hebrew: '\u05D3', name: 'Dalet',      value: 4 },
    e: { hebrew: '\u05D4', name: 'He',         value: 5 },
    f: { hebrew: '\u05D5', name: 'Vav',        value: 6 },
    g: { hebrew: '\u05D6', name: 'Zayin',      value: 7 },
    h: { hebrew: '\u05D7', name: 'Chet',       value: 8 },
    i: { hebrew: '\u05D8', name: 'Tet',        value: 9 },
    j: { hebrew: '\u05D9', name: 'Yod',        value: 10 },
    k: { hebrew: '\u05DB', name: 'Kaf',        value: 20 },
    l: { hebrew: '\u05DC', name: 'Lamed',      value: 30 },
    m: { hebrew: '\u05DE', name: 'Mem',        value: 40 },
    n: { hebrew: '\u05E0', name: 'Nun',        value: 50 },
    o: { hebrew: '\u05E1', name: 'Samekh',     value: 60 },
    p: { hebrew: '\u05E2', name: 'Ayin',       value: 70 },
    q: { hebrew: '\u05E4', name: 'Pe',         value: 80 },
    r: { hebrew: '\u05E6', name: 'Tsade',      value: 90 },
    s: { hebrew: '\u05E7', name: 'Qof',        value: 100 },
    t: { hebrew: '\u05E8', name: 'Resh',       value: 200 },
    u: { hebrew: '\u05E9', name: 'Shin',       value: 300 },
    v: { hebrew: '\u05EA', name: 'Tav',        value: 400 },
    w: { hebrew: '\u05D5\u05D5', name: 'Double Vav', value: 12 },
    x: { hebrew: '\u05E1', name: 'Samekh',     value: 60 },
    y: { hebrew: '\u05D9', name: 'Yod',        value: 10 },
    z: { hebrew: '\u05D6', name: 'Zayin',      value: 7 },
  };

  // Compute gematria value for a single word
  function wordGematria(word) {
    let total = 0;
    for (const ch of word.toLowerCase()) {
      if (GEMATRIA[ch]) total += GEMATRIA[ch].value;
    }
    return total;
  }

  // Compute the digital root (Mispar Katan Mispari) — keep summing digits until single digit
  function digitalRoot(n) {
    if (n === 0) return 0;
    const r = n % 9;
    return r === 0 ? 9 : r;
  }

  // Return the step-by-step reduction from a number down to its digital root
  // e.g. 782 → [782, 17, 8]
  function digitalRootSteps(n) {
    if (n <= 0) return [0];
    const steps = [n];
    let current = n;
    while (current > 9) {
      let sum = 0;
      while (current > 0) {
        sum += current % 10;
        current = Math.floor(current / 10);
      }
      steps.push(sum);
      current = sum;
    }
    return steps;
  }

  // Compute full gematria breakdown for text
  function computeGematria(text) {
    const lower = text.toLowerCase();
    let totalValue = 0;
    let letterCount = 0;

    for (const ch of lower) {
      if (GEMATRIA[ch]) {
        totalValue += GEMATRIA[ch].value;
        letterCount++;
      }
    }

    const words = text.split(/\s+/).filter(w => w.length > 0);
    const wordBreakdown = words.map(w => ({
      text: w,
      value: wordGematria(w),
    }));

    const letterBreakdown = [];
    for (const ch of lower) {
      if (GEMATRIA[ch]) {
        letterBreakdown.push({
          char: ch, hebrew: GEMATRIA[ch].hebrew,
          name: GEMATRIA[ch].name, value: GEMATRIA[ch].value, isAlpha: true,
        });
      } else {
        letterBreakdown.push({
          char: ch === ' ' ? '\u2423' : ch,
          hebrew: '', name: '', value: 0, isAlpha: false,
        });
      }
    }

    return { totalValue, letterCount, wordBreakdown, letterBreakdown };
  }

  // HTML-escape utility
  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  let currentLayout = 'standard';

  const textInput = document.getElementById('textInput');
  const charCounter = document.getElementById('charCounter');
  const barChart = document.getElementById('barChart');
  const keyboard = document.getElementById('keyboard');

  // Build bar chart
  function buildBarChart() {
    barChart.innerHTML = '';
    LETTERS.forEach(letter => {
      const wrapper = document.createElement('div');
      wrapper.className = 'bar-wrapper';

      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.id = `bar-${letter}`;
      bar.style.height = '0px';
      bar.style.background = '#1a2a44';

      const tooltip = document.createElement('div');
      tooltip.className = 'bar-tooltip';
      tooltip.id = `tip-${letter}`;
      tooltip.textContent = `${letter.toUpperCase()}: 0`;
      bar.appendChild(tooltip);

      const label = document.createElement('div');
      label.className = 'bar-label';
      label.textContent = letter;

      wrapper.appendChild(bar);
      wrapper.appendChild(label);
      barChart.appendChild(wrapper);
    });
  }

  // Build standard keyboard
  function buildStandardKeyboard() {
    keyboard.innerHTML = '';
    keyboard.className = 'keyboard';
    KB_ROWS.forEach(row => {
      const rowEl = document.createElement('div');
      rowEl.className = 'kb-row';

      row.keys.forEach(k => {
        const key = document.createElement('div');
        key.className = 'key' + (row.type === 'number' ? ' key-number' : '');
        key.id = `key-${k}`;
        key.style.background = 'var(--bg-tertiary)';

        const letter = document.createElement('span');
        letter.className = 'letter';
        letter.textContent = k.toUpperCase();

        const count = document.createElement('span');
        count.className = 'count';
        count.id = `kc-${k}`;
        count.textContent = '';

        key.appendChild(letter);
        key.appendChild(count);
        rowEl.appendChild(key);
      });

      keyboard.appendChild(rowEl);
    });
  }

  // Build Sofle v2 split keyboard
  function buildSofleKeyboard() {
    keyboard.innerHTML = '';
    keyboard.className = 'keyboard-split';

    function buildHalf(halfData, colOffsets, side) {
      const halfEl = document.createElement('div');
      halfEl.className = 'keyboard-half';

      halfData.forEach((row, rowIdx) => {
        const rowEl = document.createElement('div');
        rowEl.className = 'kb-row-stagger';

        row.forEach((item, colIdx) => {
          const isThumbRow = item.type === 'thumb';
          const wrapper = document.createElement('div');
          wrapper.className = 'key-stagger';

          // Apply column stagger offset for non-thumb rows
          if (!isThumbRow && colOffsets[colIdx] !== undefined) {
            wrapper.style.marginTop = colOffsets[colIdx] + 'px';
          }

          const key = document.createElement('div');
          const isChar = item.type === 'char';
          let extraClass = ' key-small';
          if (item.type === 'mod') extraClass = ' key-small key-mod';
          if (item.type === 'encoder') extraClass = ' key-small key-encoder';
          if (item.type === 'thumb') extraClass = ' key-small key-thumb';

          key.className = 'key' + extraClass;
          key.style.background = 'var(--bg-tertiary)';

          // Only assign IDs for trackable characters (letters/numbers)
          if (isChar) {
            key.id = `key-${item.key}`;
          }

          const letterSpan = document.createElement('span');
          letterSpan.className = 'letter';
          letterSpan.textContent = isChar ? item.key.toUpperCase() : item.key;

          const countSpan = document.createElement('span');
          countSpan.className = 'count';
          if (isChar) {
            countSpan.id = `kc-${item.key}`;
          }
          countSpan.textContent = '';

          key.appendChild(letterSpan);
          key.appendChild(countSpan);
          wrapper.appendChild(key);
          rowEl.appendChild(wrapper);
        });

        halfEl.appendChild(rowEl);
      });

      return halfEl;
    }

    keyboard.appendChild(buildHalf(SOFLE_LEFT, SOFLE_COL_OFFSETS_L, 'left'));
    keyboard.appendChild(buildHalf(SOFLE_RIGHT, SOFLE_COL_OFFSETS_R, 'right'));
  }

  // Build keyboard based on current layout
  function buildKeyboard() {
    if (currentLayout === 'sofle') {
      buildSofleKeyboard();
    } else {
      buildStandardKeyboard();
    }
  }

  // Layout toggle
  document.getElementById('layoutToggle').addEventListener('click', function(e) {
    const label = e.target.closest('.toggle-label');
    if (!label) return;
    const layout = label.dataset.layout;
    if (layout === currentLayout) return;

    currentLayout = layout;
    this.querySelectorAll('.toggle-label').forEach(l => l.classList.remove('active'));
    label.classList.add('active');

    buildKeyboard();
    update();
  });

  // Color interpolation
  function getHeatColor(ratio) {
    // Blue → Cyan → Green → Yellow → Orange → Red
    const stops = [
      { r: 26, g: 42, b: 68 },    // 0.0 - dark blue
      { r: 30, g: 70, b: 120 },    // 0.15
      { r: 40, g: 110, b: 160 },   // 0.3 - cyan-blue
      { r: 60, g: 140, b: 70 },    // 0.45 - green
      { r: 180, g: 170, b: 30 },   // 0.6 - yellow
      { r: 210, g: 110, b: 30 },   // 0.75 - orange
      { r: 210, g: 50, b: 40 },    // 0.9 - red
      { r: 255, g: 30, b: 30 },    // 1.0 - hot red
    ];

    const t = Math.max(0, Math.min(1, ratio));
    const segment = t * (stops.length - 1);
    const i = Math.floor(segment);
    const f = segment - i;

    if (i >= stops.length - 1) return stops[stops.length - 1];

    const a = stops[i], b = stops[i + 1];
    return {
      r: Math.round(a.r + (b.r - a.r) * f),
      g: Math.round(a.g + (b.g - a.g) * f),
      b: Math.round(a.b + (b.b - a.b) * f),
    };
  }

  // Gematria DOM updates
  function updateGematriaSection(gem) {
    // Total display
    document.getElementById('gemTotalValue').textContent = gem.totalValue;
    document.getElementById('gemTotalSub').textContent =
      gem.letterCount > 0 ? `${gem.letterCount} letter${gem.letterCount !== 1 ? 's' : ''} evaluated` : '';

    // Root number display
    const root = gem.totalValue > 0 ? digitalRoot(gem.totalValue) : 0;
    document.getElementById('rootNumberValue').textContent = root;

    const stepsEl = document.getElementById('rootNumberSteps');
    if (gem.totalValue > 9) {
      const steps = digitalRootSteps(gem.totalValue);
      let html = '';
      steps.forEach((s, idx) => {
        if (idx > 0) html += '<span class="root-step-arrow">&rarr;</span>';
        if (idx === steps.length - 1) {
          html += '<span class="root-step-final">' + s + '</span>';
        } else {
          html += s;
        }
      });
      stepsEl.innerHTML = html;
    } else if (gem.totalValue > 0) {
      stepsEl.innerHTML = '<span class="root-step-final">single digit</span>';
    } else {
      stepsEl.innerHTML = '';
    }

    // Per-word breakdown
    const wordsContainer = document.getElementById('gematriaWords');
    if (gem.wordBreakdown.length === 0) {
      wordsContainer.innerHTML =
        '<div class="empty-state" style="width:100%">' +
          '<div class="icon">&#x05D0;</div>' +
          '<div>Type something to see its gematria value</div>' +
        '</div>';
    } else {
      wordsContainer.innerHTML = '';
      gem.wordBreakdown.forEach(w => {
        const pill = document.createElement('div');
        pill.className = 'gem-word';
        pill.innerHTML =
          '<span class="gem-word-text">' + escapeHtml(w.text) + '</span>' +
          '<span class="gem-word-eq">=</span>' +
          '<span class="gem-word-value">' + w.value + '</span>';
        wordsContainer.appendChild(pill);
      });
    }

    // Per-letter breakdown (lazy: only render when visible)
    const lettersContainer = document.getElementById('gematriaLetters');
    lettersContainer._data = gem.letterBreakdown;
    if (lettersContainer.style.display !== 'none') {
      renderLetterBreakdown(gem.letterBreakdown, lettersContainer);
    }
  }

  function renderLetterBreakdown(data, container) {
    container.innerHTML = '';
    if (!data || data.length === 0) return;
    data.forEach(item => {
      const el = document.createElement('div');
      el.className = 'gem-letter' + (item.isAlpha ? '' : ' non-alpha');
      if (item.isAlpha) {
        el.innerHTML =
          '<div class="gem-letter-char">' + item.char.toUpperCase() + '</div>' +
          '<div class="gem-letter-hebrew">' + item.hebrew + '</div>' +
          '<div class="gem-letter-val">' + item.value + '</div>';
      } else {
        el.innerHTML = '<div class="gem-letter-char">' + escapeHtml(item.char) + '</div>';
      }
      container.appendChild(el);
    });
  }

  // Build static gematria reference table
  function buildGematriaRef() {
    const container = document.getElementById('gematriaRef');
    const grid = document.createElement('div');
    grid.className = 'gem-ref-grid';
    LETTERS.forEach(letter => {
      const g = GEMATRIA[letter];
      const item = document.createElement('div');
      item.className = 'gem-ref-item';
      item.innerHTML =
        '<span class="gem-ref-eng">' + letter.toUpperCase() + '</span>' +
        '<span class="gem-ref-heb">' + g.hebrew + '</span>' +
        '<span class="gem-ref-name">' + g.name + '</span>' +
        '<span class="gem-ref-val">' + g.value + '</span>';
      grid.appendChild(item);
    });
    container.appendChild(grid);
  }

  function update() {
    const text = textInput.value.toLowerCase();
    const len = textInput.value.length;

    // Char counter
    charCounter.textContent = `${len} / 500`;
    charCounter.className = 'char-counter' + (len > 450 ? ' danger' : len > 380 ? ' warning' : '');

    // Count frequencies
    const freq = {};
    const allKeys = [...LETTERS, ...NUMBERS];
    allKeys.forEach(c => freq[c] = 0);

    for (const ch of text) {
      if (freq.hasOwnProperty(ch)) freq[ch]++;
    }

    const letterCounts = LETTERS.map(l => freq[l]);
    const maxCount = Math.max(...allKeys.map(k => freq[k]), 1);
    const maxLetterCount = Math.max(...letterCounts, 1);
    const totalLetters = letterCounts.reduce((a, b) => a + b, 0);
    const uniqueLetters = letterCounts.filter(c => c > 0).length;

    // Find top letter
    let topLetter = '—';
    let topCount = 0;
    LETTERS.forEach(l => {
      if (freq[l] > topCount) { topCount = freq[l]; topLetter = l.toUpperCase(); }
    });

    // Update stats
    document.getElementById('statTotal').textContent = len;
    document.getElementById('statLetters').textContent = totalLetters;
    document.getElementById('statUnique').textContent = uniqueLetters;
    document.getElementById('statTop').textContent = topCount > 0 ? `${topLetter} (${topCount})` : '—';

    // Update bars
    LETTERS.forEach(l => {
      const bar = document.getElementById(`bar-${l}`);
      const tip = document.getElementById(`tip-${l}`);
      const count = freq[l];
      const ratio = maxLetterCount > 0 ? count / maxLetterCount : 0;
      const heightPx = count > 0 ? Math.max(4, (ratio * 180)) : 0;

      bar.style.height = `${heightPx}px`;
      const color = getHeatColor(ratio);
      bar.style.background = count > 0
        ? `rgb(${color.r}, ${color.g}, ${color.b})`
        : '#1a2a44';
      tip.textContent = `${l.toUpperCase()}: ${count}`;
    });

    // Update keyboard
    allKeys.forEach(k => {
      const keyEl = document.getElementById(`key-${k}`);
      const countEl = document.getElementById(`kc-${k}`);
      if (!keyEl || !countEl) return;
      const count = freq[k];
      const ratio = maxCount > 0 ? count / maxCount : 0;

      if (count > 0) {
        const color = getHeatColor(ratio);
        keyEl.style.background = `rgb(${color.r}, ${color.g}, ${color.b})`;
        keyEl.style.borderColor = `rgba(${Math.min(255, color.r + 40)}, ${Math.min(255, color.g + 20)}, ${Math.min(255, color.b + 20)}, 0.4)`;
        keyEl.classList.add('active');
        countEl.textContent = count;
      } else {
        keyEl.style.background = 'var(--bg-tertiary)';
        keyEl.style.borderColor = 'var(--border)';
        keyEl.classList.remove('active');
        countEl.textContent = '';
      }
    });

    // Update gematria
    const gem = computeGematria(textInput.value);
    document.getElementById('statGematria').textContent = gem.totalValue || '0';
    const rootVal = gem.totalValue > 0 ? digitalRoot(gem.totalValue) : 0;
    document.getElementById('statRoot').textContent = rootVal;
    updateGematriaSection(gem);
  }

  // Gematria letter breakdown toggle
  document.getElementById('gemLettersToggle').addEventListener('click', function() {
    const container = document.getElementById('gematriaLetters');
    const arrow = document.getElementById('gemToggleArrow');
    const isHidden = container.style.display === 'none';
    container.style.display = isHidden ? 'flex' : 'none';
    arrow.classList.toggle('open', isHidden);
    if (isHidden && container._data) {
      renderLetterBreakdown(container._data, container);
    }
  });

  // Gematria explainer toggle
  document.getElementById('gemExplainerToggle').addEventListener('click', function() {
    const body = document.getElementById('gemExplainerBody');
    const arrow = document.getElementById('gemExplainerArrow');
    const isHidden = body.style.display === 'none';
    body.style.display = isHidden ? 'block' : 'none';
    arrow.classList.toggle('open', isHidden);
  });

  // Gematria mapping reference toggle
  document.getElementById('gemRefToggle').addEventListener('click', function() {
    const container = document.getElementById('gematriaRef');
    const arrow = document.getElementById('gemRefArrow');
    const isHidden = container.style.display === 'none';
    container.style.display = isHidden ? 'block' : 'none';
    arrow.classList.toggle('open', isHidden);
  });

  // Init
  buildBarChart();
  buildKeyboard();
  buildGematriaRef();

  textInput.addEventListener('input', update);

  // Start with a demo sentence so it's not empty
  textInput.value = '';
  update();
</script>

</body>
</html>
